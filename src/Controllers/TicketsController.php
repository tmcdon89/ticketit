<?php

namespace Kordy\Ticketit\Controllers;

use App\Http\Controllers\Controller;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Kordy\Ticketit\Models;
use Kordy\Ticketit\Models\Agent;
use Kordy\Ticketit\Models\Attachment;
use Kordy\Ticketit\Models\Setting;
use Kordy\Ticketit\Models\Ticket;
use Kordy\Ticketit\Requests\PrepareTicketStoreRequest;
use Kordy\Ticketit\Requests\PrepareTicketUpdateRequest;
use Kordy\Ticketit\Transformers\TicketTransformer;
use League\Fractal\Pagination\IlluminatePaginatorAdapter;

class TicketsController extends Controller
{
    protected $tickets;
    protected $agent;

    public function __construct(Ticket $tickets, Agent $agent)
    {
        $this->middleware('Kordy\Ticketit\Middleware\ResAccessMiddleware', ['only' => ['show']]);
        $this->middleware('Kordy\Ticketit\Middleware\IsAgentMiddleware', ['only' => ['edit', 'update']]);
        $this->middleware('Kordy\Ticketit\Middleware\IsAdminMiddleware', ['only' => ['destroy']]);

        $this->tickets = $tickets;
        $this->agent = $agent;
    }

    public function data(Request $request)
    {
        $this->validate($request, [
            'complete' => 'required|in:0,1',
            'rowCount' => 'required|integer|min:1|max:' . max(Setting::grab('length_menu')),
            'page' => 'integer',
            'sort.*' => 'in:asc,desc'
        ]);

        $user = $this->agent->find(auth()->user()->id);

        $complete = $request->complete;

        if ($user->isAdmin()) {
            if ($complete) {
                $query = Ticket::complete();
            }else {
                $query = Ticket::active();
            }
        }elseif ($user->isAgent()) {
            if ($complete) {
                $query = Ticket::complete()->agentUserTickets($user->id);
            }else {
                $query = Ticket::active()->agentUserTickets($user->id);
            }
        }else {
            if ($complete) {
                $query = Ticket::userTickets($user->id)->complete();
            }else {
                $query = Ticket::userTickets($user->id)->active();
            }
        }

        $query
            ->leftJoin('users', 'users.id', '=', 'ticketit.user_id')
            ->leftJoin('ticketit_statuses', 'ticketit_statuses.id', '=', 'ticketit.status_id')
            ->leftJoin('ticketit_priorities', 'ticketit_priorities.id', '=', 'ticketit.priority_id')
            ->leftJoin('ticketit_categories', 'ticketit_categories.id', '=', 'ticketit.category_id')
            ->leftJoin('users as agents', 'ticketit.agent_id', '=', 'agents.id')
            ->select([
                'ticketit.id',
                'ticketit.subject AS subject',
                'ticketit_statuses.name AS status',
                'ticketit_statuses.color AS color_status',
                'ticketit_priorities.color AS color_priority',
                'ticketit_categories.color AS color_category',
                'ticketit.updated_at AS updated_at',
                'ticketit_priorities.name AS priority',
                'agents.name AS agent_name',
                'users.name AS owner',
                'ticketit.agent_id',
                'ticketit_categories.name AS category',
            ]);

        if($request->sort){
            //allows multisort, see bootgrid documentation
            foreach ($request->sort as $field => $direction){
                if(in_array($field, ['agent_name', 'id', 'category', 'owner', 'priority', 'status', 'subject', 'updated_at'])){
                    $query->orderBy($field, $direction);
                }
            }
        }

        if($request->searchPhrase){
            $query->search($request->searchPhrase);
        }


        $paginator = $query->paginate($request->rowCount);
        $tickets = $paginator->getCollection();

        return fractal()->collection($tickets)
            ->transformWith(new TicketTransformer())
            ->paginateWith(new IlluminatePaginatorAdapter($paginator))
            ->toJson();
    }


    /**
     * Display a listing of active tickets related to user.
     *
     * @return Response
     */
    public function index()
    {
        $complete = false;

        return view('ticketit::index', compact('complete'));
    }

    /**
     * Display a listing of completed tickets related to user.
     *
     * @return Response
     */
    public function indexComplete()
    {
        $complete = true;

        return view('ticketit::index', compact('complete'));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return Response
     */
    public function create()
    {
        $priorities = Models\Priority::lists('name', 'id');
        $categories = Models\Category::lists('name', 'id');

        $agents = \App\User::where('ticketit_agent', '1')->lists('name', 'id')->toArray();
        if (is_array($agents)) {
            $agent_lists = ['auto' => 'Auto Select'] + $agents;
        }else {
            $agent_lists = ['auto' => 'Auto Select'];
        }

        return view('ticketit::tickets.create', compact('priorities', 'categories', 'agent_lists'));
    }

    /**
     * Store a newly created ticket and auto assign an agent for it.
     *
     * @param Request $request
     *
     * @return Response redirect to index
     */
    public function store(PrepareTicketStoreRequest $request)
    {
        $ticket = new Ticket();

        $ticket->subject = $request->subject;

        $ticket->setPurifiedContent($request->get('content'));

        $ticket->priority_id = $request->priority_id;
        $ticket->category_id = $request->category_id;

        $ticket->status_id = Setting::grab('default_status_id');

        if (!$request->user || $request->user == 0) {
            $ticket->user_id = auth()->user()->id;
        }else {
            $ticket->user_id = $request->user;
        }

        if ($request->input('agent_id') == 'auto') {
            $ticket->autoSelectAgent();
        }else {
            $ticket->agent_id = $request->input('agent_id');
        }

        $ticket->save();

        if ($request->hasFile('file_upload')) {
            $file = $request->file('file_upload');
            $extension = $file->getClientOriginalExtension();
            $filename = $file->getFileName() . '.' . $extension;
            $filepath = '/app/attachments/' . $ticket->user_id . '/';
            $file->move(storage_path() . $filepath, $filename);

            $file_entry = new Attachment();
            $file_entry->mime = $file->getClientMimeType();
            $file_entry->original_filename = $file->getClientOriginalName();
            $file_entry->filename = $filename;
            $file_entry->filepath = $filepath;
            $file_entry->ticket_id = $ticket->id;
            $file_entry->save();
        }

        session()->flash('status', trans('ticketit::lang.the-ticket-has-been-created'));

        return redirect()->action('\Kordy\Ticketit\Controllers\TicketsController@index');
    }

    /**
     * Display the specified resource.
     *
     * @param int $id
     *
     * @return Response
     */
    public function show($id)
    {
        $ticket = $this->tickets->find($id);

        $status_lists = Models\Status::lists('name', 'id');
        $priority_lists = Models\Priority::lists('name', 'id');
        $category_lists = Models\Category::lists('name', 'id');

        $close_perm = $this->permToClose($id);
        $reopen_perm = $this->permToReopen($id);

        $cat_agents = Models\Category::find($ticket->category_id)->agents()->agentsLists();
        if (is_array($cat_agents)) {
            $agent_lists = ['auto' => 'Auto Select'] + $cat_agents;
        }else {
            $agent_lists = ['auto' => 'Auto Select'];
        }

        $comments = $ticket->comments()->orderBy('id', 'desc')->paginate(Setting::grab('paginate_items'));

        $total_time = 0;
        foreach ($ticket->comments as $comment) {
            $total_time += $comment->time_spent;
        }
        $total_hours = intval($total_time / 60);
        $total_minutes = $total_time % 60;

        return view('ticketit::tickets.show',
            compact('ticket', 'status_lists', 'priority_lists', 'category_lists', 'agent_lists', 'comments',
                'close_perm', 'reopen_perm', 'total_hours', 'total_minutes'));
    }

    /**
     * Update the specified resource in storage.
     *
     * @param Request $request
     * @param int $id
     *
     * @return Response
     */
    public function update(PrepareTicketUpdateRequest $request, $id)
    {
        $ticket = $this->tickets->findOrFail($id);

        $ticket->subject = $request->subject;

        $ticket->setPurifiedContent($request->get('content'));

        $ticket->status_id = $request->status_id;
        $ticket->category_id = $request->category_id;
        $ticket->priority_id = $request->priority_id;

        if ($request->input('agent_id') == 'auto') {
            $ticket->autoSelectAgent();
        }else {
            $ticket->agent_id = $request->input('agent_id');
        }

        $ticket->save();

        session()->flash('status', trans('ticketit::lang.the-ticket-has-been-modified'));

        return redirect()->route(Setting::grab('main_route') . '.show', $id);
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param int $id
     *
     * @return Response
     */
    public function destroy($id)
    {
        $ticket = $this->tickets->findOrFail($id);
        $subject = $ticket->subject;
        $ticket->delete();

        session()->flash('status', trans('ticketit::lang.the-ticket-has-been-deleted', ['name' => $subject]));

        return redirect()->route(Setting::grab('main_route') . '.index');
    }

    /**
     * Mark ticket as complete.
     *
     * @param int $id
     *
     * @return Response
     */
    public function complete($id)
    {
        if ($this->permToClose($id) == 'yes') {
            $ticket = $this->tickets->findOrFail($id);
            $ticket->completed_at = Carbon::now();

            if (Setting::grab('default_close_status_id')) {
                $ticket->status_id = Setting::grab('default_close_status_id');
            }

            $subject = $ticket->subject;
            $ticket->save();

            session()->flash('status', trans('ticketit::lang.the-ticket-has-been-completed', ['name' => $subject]));

            return redirect()->route(Setting::grab('main_route') . '.index');
        }

        return redirect()->route(Setting::grab('main_route') . '.index')
            ->with('warning', trans('ticketit::lang.you-are-not-permitted-to-do-this'));
    }

    /**
     * Reopen ticket from complete status.
     *
     * @param int $id
     *
     * @return Response
     */
    public function reopen($id)
    {
        if ($this->permToReopen($id) == 'yes') {
            $ticket = $this->tickets->findOrFail($id);
            $ticket->completed_at = null;

            if (Setting::grab('default_reopen_status_id')) {
                $ticket->status_id = Setting::grab('default_reopen_status_id');
            }

            $subject = $ticket->subject;
            $ticket->save();

            session()->flash('status', trans('ticketit::lang.the-ticket-has-been-reopened', ['name' => $subject]));

            return redirect()->route(Setting::grab('main_route') . '.index');
        }

        return redirect()->route(Setting::grab('main_route') . '.index')
            ->with('warning', trans('ticketit::lang.you-are-not-permitted-to-do-this'));
    }

    public function agentSelectList($category_id, $ticket_id)
    {
        $cat_agents = Models\Category::find($category_id)->agents()->agentsLists();
        if (is_array($cat_agents)) {
            $agents = ['auto' => 'Auto Select'] + $cat_agents;
        }else {
            $agents = ['auto' => 'Auto Select'];
        }

        $selected_Agent = $this->tickets->find($ticket_id)->agent->id;
        $select = '<select class="form-control" id="agent_id" name="agent_id">';
        foreach ($agents as $id => $name) {
            $selected = ($id == $selected_Agent) ? 'selected' : '';
            $select .= '<option value="' . $id . '" ' . $selected . '>' . $name . '</option>';
        }
        $select .= '</select>';

        return $select;
    }

    /**
     * @param $id
     *
     * @return bool
     */
    public function permToClose($id)
    {
        $close_ticket_perm = Setting::grab('close_ticket_perm');

        if ($this->agent->isAdmin() && $close_ticket_perm['admin'] == 'yes') {
            return 'yes';
        }
        if ($this->agent->isAgent() && $close_ticket_perm['agent'] == 'yes') {
            return 'yes';
        }
        if ($this->agent->isTicketOwner($id) && $close_ticket_perm['owner'] == 'yes') {
            return 'yes';
        }

        return 'no';
    }

    /**
     * @param $id
     *
     * @return bool
     */
    public function permToReopen($id)
    {
        $reopen_ticket_perm = Setting::grab('reopen_ticket_perm');
        if ($this->agent->isAdmin() && $reopen_ticket_perm['admin'] == 'yes') {
            return 'yes';
        }elseif ($this->agent->isAgent() && $reopen_ticket_perm['agent'] == 'yes') {
            return 'yes';
        }elseif ($this->agent->isTicketOwner($id) && $reopen_ticket_perm['owner'] == 'yes') {
            return 'yes';
        }

        return 'no';
    }

    /**
     * Calculate average closing period of days per category for number of months.
     *
     * @param int $period
     *
     * @return \Illuminate\Database\Eloquent\Collection|static[]
     */
    public function monthlyPerfomance($period, $categories_all)
    {
        foreach ($categories_all as $category) {
            $records['categories'][] = $category->name;
        }
        for ($m = $period; $m >= 0; $m--) {
            $from = Carbon::now();
            $from->day = 1;
            $from->subMonth($m);
            $to = Carbon::now();
            $to->day = 1;
            $to->subMonth($m);
            $to->endOfMonth();
            $records['interval'][$from->format('F Y')] = [];
            foreach ($categories_all as $category) {
                $records['interval'][$from->format('F Y')][] = round($this->intervalPerformance($from, $to, $category),
                    1);
            }
        }

        return $records;
    }

    /**
     * Calculate the average date length it took to solve tickets within date period.
     *
     * @param $from
     * @param $to
     *
     * @return int
     */
    public function intervalPerformance($from, $to, $category)
    {
        $tickets = $category->tickets->filter(function ($ticket) use ($from, $to){
            $completed = new Carbon($ticket->completed_at);

            return $completed->between(new Carbon($from), new Carbon($to));
        });

        if (!$tickets->count() > 0) {
            return 0;
        }

        $performance_count = 0;
        $counter = 0;
        foreach ($tickets as $ticket) {
            $performance_count += $this->ticketPerformance($ticket);
            $counter++;
        }
        $performance_average = $performance_count / $counter;

        return $performance_average;
    }

    /**
     * Calculate the date length it took to solve a ticket.
     *
     * @param Ticket $ticket
     *
     * @return int|false
     */
    public function ticketPerformance($ticket)
    {
        if ($ticket->completed_at == null) {
            return false;
        }

        $created = new Carbon($ticket->created_at);
        $completed = new Carbon($ticket->completed_at);
        $length = $created->diff($completed)->days;

        return $length;
    }
}
